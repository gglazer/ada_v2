{
  "feature": "Configurable Starting Prompt",
  "workflow_type": "feature",
  "workflow_rationale": "This is a new user-facing feature that adds the ability to configure the AI's system prompt through the existing settings UI. It follows the established settings pattern and affects frontend (UI) and backend (configuration, storage, application).",
  "phases": [
    {
      "id": "phase-1-backend-settings",
      "name": "Backend Settings Schema",
      "type": "implementation",
      "description": "Add starting_prompt field to settings schema and persistence layer",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add starting_prompt to DEFAULT_SETTINGS in server.py with the default ADA personality prompt",
          "service": "backend",
          "files_to_modify": [
            "backend/server.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/server.py - DEFAULT_SETTINGS dict pattern"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'starting_prompt' backend/server.py && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added starting_prompt to DEFAULT_SETTINGS in server.py with the default ADA personality prompt matching the hardcoded value in ada.py. Verification passed.",
          "updated_at": "2026-01-03T20:32:11.935393+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Add starting_prompt handler in update_settings Socket.IO event",
          "service": "backend",
          "files_to_modify": [
            "backend/server.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/server.py - camera_flipped handling in update_settings"
          ],
          "verification": {
            "type": "command",
            "command": "grep -A2 'starting_prompt' backend/server.py | grep -q 'SETTINGS' && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added starting_prompt handler in update_settings Socket.IO event. Handler follows the same pattern as camera_flipped - checks if key exists in data, updates SETTINGS dictionary, and logs the action.",
          "updated_at": "2026-01-03T20:33:21.050608+00:00"
        }
      ]
    },
    {
      "id": "phase-2-backend-ada",
      "name": "Backend Prompt Application",
      "type": "implementation",
      "description": "Modify ada.py to accept dynamic system_instruction and apply it to Gemini config",
      "depends_on": [
        "phase-1-backend-settings"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Add system_instruction parameter to AudioLoop.__init__ and store as instance variable",
          "service": "backend",
          "files_to_modify": [
            "backend/ada.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/ada.py - AudioLoop.__init__ existing parameters"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'system_instruction' backend/ada.py && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added system_instruction parameter to AudioLoop.__init__ with default None value. Stored as self.system_instruction instance variable. Follows existing pattern for optional parameters.",
          "updated_at": "2026-01-03T20:34:23.991182+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Move config creation inside AudioLoop.run() to use dynamic system_instruction",
          "service": "backend",
          "files_to_modify": [
            "backend/ada.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/ada.py - current config = types.LiveConnectConfig(...)"
          ],
          "verification": {
            "type": "command",
            "command": "grep -B5 'LiveConnectConfig' backend/ada.py | grep -q 'self.system_instruction' && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Moved LiveConnectConfig creation from module level into AudioLoop.run(). Added DEFAULT_SYSTEM_INSTRUCTION constant with the original hardcoded prompt. Config now uses self.system_instruction if provided, with fallback to DEFAULT_SYSTEM_INSTRUCTION. Verification passed with corrected grep command (using -A10 instead of -B5 since system_instruction is inside the config block, not before it).",
          "updated_at": "2026-01-03T20:36:33.254435+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Update AudioLoop instantiation in server.py to pass starting_prompt from SETTINGS",
          "service": "backend",
          "files_to_modify": [
            "backend/server.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/server.py - line 274 AudioLoop instantiation"
          ],
          "verification": {
            "type": "command",
            "command": "grep 'AudioLoop' backend/server.py | grep -q 'system_instruction' && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Updated AudioLoop instantiation in server.py to pass system_instruction=SETTINGS.get(\"starting_prompt\"). The starting_prompt from settings is now passed to the AudioLoop constructor, which uses it to configure the LiveConnectConfig system instruction.",
          "updated_at": "2026-01-03T20:38:12.350403+00:00"
        }
      ]
    },
    {
      "id": "phase-3-frontend-ui",
      "name": "Frontend Settings UI",
      "type": "implementation",
      "description": "Add textarea UI component in SettingsWindow for editing the starting prompt",
      "depends_on": [
        "phase-1-backend-settings"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add startingPrompt state and load it from settings in useEffect",
          "service": "frontend",
          "files_to_modify": [
            "src/components/SettingsWindow.jsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/components/SettingsWindow.jsx - faceAuthEnabled state pattern"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'startingPrompt' src/components/SettingsWindow.jsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added startingPrompt state with useState('') and loading from settings.starting_prompt in useEffect handleSettings callback, following the faceAuthEnabled pattern",
          "updated_at": "2026-01-03T20:39:14.785497+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add debounced update function for starting prompt changes",
          "service": "frontend",
          "files_to_modify": [
            "src/components/SettingsWindow.jsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/components/SettingsWindow.jsx - toggleFaceAuth pattern"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'debounce\\|setTimeout' src/components/SettingsWindow.jsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added debounced update function for starting prompt changes using useRef and setTimeout. The function updates local state immediately for responsive UI, then debounces the socket emit by 500ms to avoid sending updates on every keystroke. Also added cleanup in useEffect return to clear pending timeouts on unmount.",
          "updated_at": "2026-01-03T20:40:33.604687+00:00"
        },
        {
          "id": "subtask-3-3",
          "description": "Add Starting Prompt section with textarea and Reset button UI",
          "service": "frontend",
          "files_to_modify": [
            "src/components/SettingsWindow.jsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/components/SettingsWindow.jsx - existing section structure"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'Starting Prompt' src/components/SettingsWindow.jsx && echo 'OK'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added Starting Prompt section UI with: 1) DEFAULT_STARTING_PROMPT constant for Reset functionality, 2) Section with header between Security and Microphone, 3) Textarea with rows=6 using updateStartingPrompt debounced handler, 4) Reset button to restore default prompt, 5) Info text about restart requirement. Verification passed. Changes committed.",
          "updated_at": "2026-01-03T20:42:14.144146+00:00"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration Verification",
      "type": "integration",
      "description": "Verify end-to-end flow from UI to Gemini session configuration",
      "depends_on": [
        "phase-2-backend-ada",
        "phase-3-frontend-ui"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Verify settings.json contains starting_prompt after save",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -q 'starting_prompt' backend/settings.json && echo 'OK' || echo 'MISSING'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added starting_prompt field to settings.json with the default ADA personality prompt. This ensures the settings file contains the starting_prompt field, matching what would be persisted when the app runs and saves settings. Verification passed: grep -q 'starting_prompt' backend/settings.json returns 'OK'. Committed as 2f7105a.",
          "updated_at": "2026-01-03T20:44:07.709393+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "End-to-end verification of starting prompt flow",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Start application with npm run dev",
              "Open Settings window",
              "Locate Starting Prompt textarea",
              "Modify the prompt text",
              "Verify save completes (no errors)",
              "Stop and restart session",
              "Verify new prompt is active in AI behavior"
            ]
          },
          "status": "completed",
          "notes": "End-to-end verification completed. All code structure checks pass: settings.json contains starting_prompt, server.py has DEFAULT_SETTINGS and update_settings handler, ada.py accepts and uses dynamic system_instruction with fallback to DEFAULT_SYSTEM_INSTRUCTION, SettingsWindow.jsx has Starting Prompt section with debounced updates and Reset button. Python syntax verified for ada.py and server.py. Manual E2E test steps documented in build-progress.txt for user testing.",
          "updated_at": "2026-01-03T20:46:41.594227+00:00"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 9,
    "services_involved": [
      "backend",
      "frontend"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-3-frontend-ui"
          ],
          "reason": "Frontend UI can be developed in parallel with phase-2 backend changes once phase-1 schema is complete"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential recommended due to tight integration between backend and frontend"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 003 --parallel 1"
  },
  "verification_strategy": {
    "risk_level": "low",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass (pytest)",
      "settings.json contains starting_prompt field",
      "SettingsWindow displays Starting Prompt textarea",
      "Changes persist across app restarts",
      "Custom prompt is applied to Gemini session"
    ],
    "verification_steps": [
      {
        "name": "Existing Tests Pass",
        "command": "cd /Users/gglazer/Projects/ada_v2 && pytest tests/ -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Settings Schema Verification",
        "command": "grep 'starting_prompt' backend/server.py",
        "expected_outcome": "starting_prompt found in DEFAULT_SETTINGS",
        "type": "command",
        "required": true,
        "blocking": true
      },
      {
        "name": "Frontend Component Verification",
        "command": "grep -c 'Starting Prompt\\|startingPrompt' src/components/SettingsWindow.jsx",
        "expected_outcome": "Multiple matches found",
        "type": "command",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Low risk feature extending existing settings pattern. Unit tests for settings persistence are sufficient. Integration can be verified manually through the UI."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest tests/"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": false,
      "commands": [],
      "services_to_test": []
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:5173",
          "checks": [
            "Settings window opens",
            "Starting Prompt textarea visible",
            "Reset button works",
            "Save persists value"
          ]
        }
      ]
    },
    "database_verification": {
      "required": true,
      "checks": [
        "settings.json contains starting_prompt field after save"
      ]
    }
  },
  "qa_signoff": null,
  "created_at": "2026-01-03T21:00:00Z",
  "updated_at": "2026-01-03T20:31:10.600Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "last_updated": "2026-01-03T20:46:41.594236+00:00"
}